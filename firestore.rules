rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------
    // Helpers
    // -------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Allow null, else minimal lat/lng/accuracy checks
    function validLocation(loc) {
      return loc == null ||
        (
          loc is map &&
          loc.lat is number && loc.lat >= -90 && loc.lat <= 90 &&
          loc.lng is number && loc.lng >= -180 && loc.lng <= 180 &&
          (loc.accuracy == null || loc.accuracy is number)
        );
    }

    // One selection entry inside a vote
    function validSelection(sel) {
      return sel is map &&
             sel.venueId is string &&
             (sel.arrivalWindow == null || sel.arrivalWindow is string);
    }

    // Non-recursive validator for selections list (supports up to 8)
    function validSelections(arr) {
      return arr is list &&
        (arr.size() >= 1 && arr.size() <= 8) &&
        validSelection(arr[0]) &&
        (
          arr.size() == 1 ||
          (validSelection(arr[1]) &&
            (
              arr.size() == 2 ||
              (validSelection(arr[2]) &&
                (
                  arr.size() == 3 ||
                  (validSelection(arr[3]) &&
                    (
                      arr.size() == 4 ||
                      (validSelection(arr[4]) &&
                        (
                          arr.size() == 5 ||
                          (validSelection(arr[5]) &&
                            (
                              arr.size() == 6 ||
                              (validSelection(arr[6]) &&
                                (
                                  arr.size() == 7 ||
                                  (validSelection(arr[7]) && arr.size() == 8)
                                )
                              )
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        );
    }

    // Validate the vote document shape and ownership
    function validVote(doc, userId) {
      return
        // required base fields
        doc is map &&
        doc.userId is string &&
        doc.nightKey is string &&
        doc.createdAt is timestamp &&
        // owned by caller
        (isSignedIn() && request.auth.uid == userId && doc.userId == userId) &&
        // selections
        (doc.selections is list && validSelections(doc.selections)) &&
        // optional fields
        validLocation(doc.location) &&
        (
          doc.intent == null || (doc.intent in ['yes','maybe','no'])
        );
    }

    // -------------------------------------------------
    // Votes: /nights/{date}/votes/{userId}
    // -------------------------------------------------
    match /nights/{date}/votes/{userId} {
      // Public reads for the Tonight page / user own history
      allow read: if true;

      // Users may write ONLY their own vote docs and only valid shapes
      allow create, update: if isSelf(userId) &&
                            validVote(request.resource.data, userId);

      // No client deletes (keeps history stable)
      allow delete: if false;
    }

    // -------------------------------------------------
    // Venue tallies (server-written, public read)
    // /nights/{date}/venueTallies/{venueId}
    // -------------------------------------------------
    match /nights/{date}/venueTallies/{venueId} {
      allow read: if true;
      allow write: if false; // only Admin/cron writes
    }

    // -------------------------------------------------
    // Prediction summaries (server-only writes)
    // /prediction_summaries/{date}
    // -------------------------------------------------
    match /prediction_summaries/{date} {
      allow read: if true;
      allow write: if false; // Admin SDK via /api/ensure-summary
    }

    // -------------------------------------------------
    // NEW: Houseparties (public read, server-only writes)
    // /houseparties/{partyId}
    // -------------------------------------------------
    match /houseparties/{partyId} {
      allow read: if true;   // show on Tonight/Houseparty pages
      allow write: if false; // created via /api/houseparty (Admin)
    }

    // -------------------------------------------------
    // Optional user profiles
    // -------------------------------------------------
    match /users/{userId} {
      allow read, write: if isSelf(userId);
    }

    // -------------------------------------------------
    // Default deny
    // -------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
